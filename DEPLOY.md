# TogglSync - Deployment Guide

Django application that syncs Toggl Track time entries to Google Calendar in real-time using webhooks.

**Stack**: Django 5.x, Django Q2, SQLite, Gunicorn, Docker/Podman

## Prerequisites

- Docker/Podman
- Public HTTPS domain (for webhooks and OAuth)
- Google Cloud project with Calendar API enabled

## Quick Start

### 1. Configure Environment

```bash
git clone <repository-url>
cd togglsync
cp .env.example .env
```

Edit `.env`:

```bash
# Generate secret key
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

DJANGO_SECRET_KEY=<generated-key>
DJANGO_WEBHOOK_DOMAIN=togglsync.example.com  # NO https://
DJANGO_ALLOWED_HOSTS=togglsync.example.com,localhost
DJANGO_DEBUG=False

GOOGLE_CLIENT_ID=<your-client-id>.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=<your-client-secret>

# Optional: Auto-create admin user
DJANGO_ADMIN_USER=admin
DJANGO_ADMIN_PASSWORD=<secure-password>
```

### 2. Google Cloud Setup

- Enable **Google Calendar API**
- Create OAuth 2.0 Client ID (Web application)
- Add redirect URI: `https://{WEBHOOK_DOMAIN}/oauth/google/callback/`
- Add scope: `https://www.googleapis.com/auth/calendar.events.owned`

### 3. Deploy

**Docker Compose:**
```bash
docker-compose build
docker-compose up -d
```

**Podman + Systemd:**
```bash
# Build image
podman build -t localhost/togglsync:latest .

# Setup
mkdir -p ~/.config/env_files ~/data/togglsync ~/.config/containers/systemd
cp .env.example ~/env_files/togglsync.env  # Edit this file
cp scripts/togglsync.container ~/.config/containers/systemd/

# Start
systemctl --user daemon-reload
systemctl --user enable --now togglsync
```

## Webhook Implementation

### How It Works

1. Admin creates webhook subscriptions via Django admin
2. TogglSync registers with Toggl API:
   - URL: `https://{DOMAIN}/webhook/toggl/{UNIQUE_TOKEN}/`
   - Events: `time_entry.created`, `time_entry.updated`, `time_entry.deleted`
3. Toggl sends PING → TogglSync echoes `validation_code`
4. Toggl sends events → TogglSync verifies HMAC signature → queues in Django Q

### Security

- **Webhook Token**: 32-char cryptographic random per workspace (identifies user/workspace)
- **Webhook Secret**: HMAC key for signature verification (generated by Toggl)
- Signature verified via `X-Webhook-Signature-256` header

### Admin Actions

**Setup webhook for selected workspaces:**
- Creates webhook subscription via Toggl API
- Handles free plan limit (1 webhook/workspace)
- Updates existing webhooks if callback URL changed

**Remove webhook:**
- Deletes subscription via API
- Keeps token for re-use

**Refresh from Toggl API:**
- Syncs workspace metadata including webhook subscriptions

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DJANGO_SECRET_KEY` | Yes | - | Django secret key |
| `DJANGO_WEBHOOK_DOMAIN` | Yes | - | Public domain **without** `https://` |
| `DJANGO_ALLOWED_HOSTS` | No | `localhost,127.0.0.1` | Comma-separated hosts |
| `DJANGO_DEBUG` | No | `False` | Debug mode |
| `DJANGO_ADMIN_USER` | No | - | Auto-create admin user |
| `DJANGO_ADMIN_PASSWORD` | No | - | Auto-create/update password |
| `GOOGLE_CLIENT_ID` | Yes | - | OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Yes | - | OAuth client secret |
| `QCLUSTER_WAIT` | No | `60` | Debounce seconds before processing entries |

## Troubleshooting

### Webhooks Not Working

**Check:**
1. `DJANGO_WEBHOOK_DOMAIN` has NO `https://` prefix
2. Domain is publicly accessible with valid SSL
3. Webhook registered: Admin → Toggl Workspaces → "Setup webhook"
4. Logs: `docker-compose logs -f | grep webhook` or `journalctl --user -u togglsync -f`

**Common issues:**
- **404**: Webhook token doesn't match any workspace
- **401**: HMAC signature verification failed
- **No events**: Webhook not enabled in Toggl

### Events Not Syncing

**Check:**
1. Google Calendar connected (User Credentials → Google OAuth status)
2. Default calendar set (Admin → Calendars)
3. QCluster running: `docker exec togglsync ps aux | grep qcluster`
4. Time entry has stop time (running entries not synced)
5. Failed tasks: `/admin/django_q/failure/`

### Django Q Task Errors

**Error**: `"takes 2 positional arguments but 4 were given"`

**Cause**: Old scheduled tasks with incorrect args format (pre-fix)

**Fix**:
```bash
docker exec togglsync python manage.py shell -c \
  "from django_q.models import Schedule; Schedule.objects.filter(func='sync.tasks.process_time_entry_event').delete()"
```

**Why**: Django Q requires args as JSON list `[arg1, arg2]`, not tuple `(arg1, arg2)`. Fixed in tasks.py line 127.

### File Permissions (Podman)

**Issue**: Files owned by wrong UID (e.g., 166535:166535)

**Fix**:
- `togglsync.container` includes `UserNS=keep-id` (maps to your user)
- Dockerfile sets `chmod 777 /data`
- Rebuild: `podman build -t localhost/togglsync:latest .`

### Database Locked

SQLite has limited concurrent writes. For production with high concurrency, consider PostgreSQL.

**Check**: `Q_CLUSTER['workers']` should be `1` for SQLite (in `config/settings.py`)

## Performance Tuning

### Webhook Debounce

Control delay before processing time entries (prevents rapid API calls):

```bash
QCLUSTER_WAIT=30  # Process after 30s of no updates
```

### Gunicorn Workers

Edit `entrypoint.sh`:
```bash
gunicorn --bind 0.0.0.0:8000 --workers 4 --threads 4 config.wsgi:application
```

Use `2 * CPU_CORES + 1` workers.

## Upgrading

```bash
# Backup
cp ./data/db.sqlite3 ./backup-$(date +%Y%m%d).sqlite3

# Upgrade
git pull origin main

# Docker
docker-compose build && docker-compose up -d

# Podman
podman build -t localhost/togglsync:latest .
systemctl --user restart togglsync

# Clear old scheduled tasks (if needed)
docker exec togglsync python manage.py shell -c \
  "from django_q.models import Schedule; Schedule.objects.filter(func='sync.tasks.process_time_entry_event').delete()"
```

## Production Checklist

- [ ] Strong `DJANGO_SECRET_KEY` generated
- [ ] `DJANGO_DEBUG=False`
- [ ] `DJANGO_WEBHOOK_DOMAIN` set (no `https://`)
- [ ] Google OAuth redirect URI: `https://{DOMAIN}/oauth/google/callback/`
- [ ] HTTPS configured (reverse proxy/tunnel)
- [ ] Database backups automated
- [ ] Webhook flow tested end-to-end

## Key Files

- **`entrypoint.sh`**: Migrations → static → admin user → qcluster → gunicorn
- **`sync/tasks.py`**: Background task processing with debounce
- **`sync/views.py`**: Webhook endpoint with signature verification
- **`sync/services/toggl.py`**: Toggl API client (webhook CRUD)
- **`scripts/togglsync.container`**: Podman systemd service
